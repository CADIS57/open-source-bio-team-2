<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í¬ë¦¬ìŠ¤ë§ˆìŠ¤ íŠ¸ë¦¬ ë””ìì¸ ìŠ¤íŠœë””ì˜¤</title>
    
    <link rel="icon" type="image/png" href="image/santa_hat.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* [14ì°¨ ì»¤ë°‹] ì‚¬ìš©ì ì§€ì • ë°°ê²½ìƒ‰ ë° ë ˆì´ì•„ì›ƒ ì„¤ì • */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #10113C; /* ì§™ì€ ë‚¨ìƒ‰ */
            min-height: 100vh;
            color: #e2e8f0; 
            transition: all 0.5s;
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ (íŠ¸ë¦¬ + ì»¨íŠ¸ë¡¤ íŒ¨ë„) */
        #main-layout {
            transition: all 0.5s ease-in-out;
        }

        /* íŠ¸ë¦¬ ëª¨ì–‘ ì»¨í…Œì´ë„ˆ */
        .tree-shape-container {
            position: relative;
            width: 300px;
            height: 400px; /* ì „ì²´ ë†’ì´ ê³ ì • */
            margin: 0 auto;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center center;
            z-index: 1;
        }
        
        /* ë‚˜ë­‡ì ì˜ì—­ */
        .tree-leafs {
            position: relative;
            width: 100%;
            height: 85%; /* 85% í• ë‹¹ */
            background-color: #16a34a;
            border-radius: 0 0 10% 10%;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.4);
            transition: clip-path 0.3s ease-in-out, border-radius 0.3s ease-in-out;
        }

        /* ë³„ ìœ„ì¹˜ ì¡°ì • */
        .tree-star {
            position: absolute;
            top: 20px; 
            left: 50%;
            transform: translate(-50%, -100%); 
            font-size: 50px;
            z-index: 20;
            pointer-events: none;
        }

        /* ì‚¼ê°í˜• íŠ¸ë¦¬ */
        .tree-shape-triangle .tree-leafs {
            clip-path: polygon(50% 0%, 100% 100%, 0% 100%);
        }

        /* ì›í˜•/ë‘¥ê·¼ íŠ¸ë¦¬ */
        .tree-shape-circle .tree-leafs {
            clip-path: none;
            border-radius: 50% 50% 10% 10% / 60% 60% 10% 10%;
        }
        
        /* ë‚˜ë¬´ ë°‘ë™ ìŠ¤íƒ€ì¼ */
        .tree-trunk {
            width: 20%;
            height: 15%; 
            background-color: #78350f; /* Brown */
            border-radius: 0 0 5px 5px;
            margin: 0 auto;
        }

        /* ì¥ì‹í’ˆ ìŠ¤íƒ€ì¼ */
        .ornament {
            position: absolute;
            min-width: 20px;
            min-height: 20px;
            max-width: 60px;
            max-height: 60px;
            transition: box-shadow 0.2s ease, border 0.2s ease, transform 0.1s;
            z-index: 10;
            border: 1px solid rgba(0, 0, 0, 0.1);
            touch-action: none; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            cursor: pointer; 
        }
        .shape-square { border-radius: 5px; }
        .shape-diamond { transform: rotate(45deg); border-radius: 5px; } 
        
        .ornament.selected {
            box-shadow: 0 0 0 4px #38bdf8, 0 0 10px rgba(56, 189, 248, 0.8);
            border: 2px solid #ffffff;
            z-index: 15; 
            cursor: grab;
        }
        
        /* [13ì°¨ ì»¤ë°‹ ìŠ¤íƒ€ì¼ ë°˜ì˜] ë“œë˜ê·¸ ì¤‘ì¼ ë•Œ */
        .ornament.dragging {
            cursor: grabbing;
            transform: scale(1.1); 
        }

        /* ì™„ë£Œ ëª¨ë“œ ì‹œ ì»¤ì„œ ë³€ê²½ ë° ìƒí˜¸ì‘ìš© ë°©ì§€ */
        .completed-mode .ornament {
            cursor: default !important;
            pointer-events: none; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
        }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„/ëª¨ë‹¬ ë°°ê²½ ì„¤ì • */
        .control-bg {
            background-color: #1e293b;
        }

        /* ìƒ‰ìƒ ì…ë ¥ í•„ë“œ ê°€ë…ì„± ê°œì„  */
        #hex-color-input {
            color: #1f2937;
            background-color: #f3f4f6;
            font-weight: bold;
        }

        /* ì™„ë£Œ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        #complete-message {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8); 
            display: flex;
            align-items: center;
            justify-content: center;
            transform: scale(0);
            opacity: 0;
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.4s ease-out;
            z-index: 100;
        }
        #complete-message.show {
            transform: scale(1);
            opacity: 1;
        }

        /* ì™„ë£Œ ìƒíƒœì—ì„œ íŠ¸ë¦¬ ì„¹ì…˜ ì¤‘ì•™ ë°°ì¹˜ */
        .completed-layout {
            height: 100vh;
            justify-content: center;
            align-items: center;
        }

        /* ëª¨ë‹¬ Z-index ì¡°ì • */
        #shape-modal {
            z-index: 50;
            background-color: rgba(16, 17, 60, 0.9); 
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex flex-col items-center">

    <button id="reset-button" class="fixed top-4 right-4 z-40 px-4 py-2 bg-yellow-500 text-gray-900 font-bold rounded-full shadow-lg hover:bg-yellow-400 transition" style="display: none;">
        ğŸ”„ ë‹¤ì‹œ í•˜ê¸°
    </button>

    <header id="main-header" class="text-center mb-8 w-full">
        <h1 class="text-4xl font-extrabold text-green-400">
            ğŸ„ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ íŠ¸ë¦¬ ë””ìì¸ ìŠ¤íŠœë””ì˜¤ ğŸ„
        </h1>
        
        <p class="text-gray-400 mt-2">íŠ¸ë¦¬ ëª¨ì–‘ì„ ì„ íƒí•˜ì—¬ ë‚˜ë§Œì˜ ì¥ì‹ì„ ì™„ì„±í•´ë³´ì„¸ìš”!</p>
    </header>

    <div id="main-layout" class="flex flex-col lg:flex-row gap-10 w-full max-w-5xl">
        <div id="tree-section" class="flex-shrink-0 w-full lg:w-1/2 flex flex-col items-center transition-all duration-500">
            <div id="tree-container-wrapper" class="w-full h-full flex justify-center items-center">
                <div id="tree-container" class="tree-shape-container"> 
                    <div class="tree-star">â­</div>
                    <div id="leafs-area" class="tree-leafs">
                    </div>
                    <div class="tree-trunk"></div>
                </div>
            </div>
        </div>

        <div id="control-panel" class="w-full lg:w-1/2 p-6 control-bg rounded-xl shadow-2xl space-y-6">
            <h2 id="panel-title" class="text-2xl font-bold text-red-400 mb-4 border-b border-gray-700 pb-2">ì¥ì‹í’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”</h2>
            
            <p id="status-message" class="text-sm text-center text-gray-400 mt-4">
                í´ë¦­ í›„ ë“œë˜ê·¸í•˜ì—¬ ìœ„ì¹˜ë¥¼ ì˜®ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>

            <button id="add-ornament-button" class="w-full py-2 bg-purple-600 text-white font-bold rounded-lg shadow-md hover:bg-purple-500 transition">
                â• ìƒˆ ì¥ì‹í’ˆ ì¶”ê°€
            </button>

            <button id="delete-ornament-button" class="w-full py-2 bg-red-600 text-white font-bold rounded-lg shadow-md hover:bg-red-500 transition disabled:opacity-50 disabled:cursor-not-allowed">
                ğŸ—‘ï¸ ì„ íƒí•œ ì¥ì‹ ì‚­ì œ
            </button>

            <div class="space-y-4 border-t border-gray-700 pt-4">
                <h3 class="text-xl font-semibold text-gray-300">ìƒ‰ìƒ ë³€ê²½</h3>
                <div id="color-inputs" class="flex justify-center items-center gap-4 p-4 border border-gray-700 rounded-lg control-bg">
                    <input type="color" id="native-color-input" class="native-color-picker" value="#ffffff" disabled>
                    <input type="text" id="hex-color-input" class="px-2 py-1 rounded w-32 text-gray-900 bg-gray-200 font-bold" value="#FFFFFF" placeholder="#FFFFFF" disabled>
                </div>
                <div class="flex flex-wrap justify-center gap-2" id="preset-colors"></div>
            </div>

            <div class="space-y-4 border-t border-gray-700 pt-4">
                <h3 class="text-xl font-semibold text-gray-300">í¬ê¸° ë³€ê²½</h3>
                <div class="flex items-center gap-4 p-4 border border-gray-700 rounded-lg control-bg">
                    <span id="size-display" class="w-10 text-center font-bold text-yellow-400">25</span>
                    <input type="range" id="size-slider" min="20" max="60" value="25" disabled class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>

            <div class="space-y-4 border-t border-gray-700 pt-4">
                <h3 class="text-xl font-semibold text-gray-300">ëª¨ì–‘ ë³€ê²½</h3>
                <div id="shape-controls" class="flex justify-center gap-4">
                    <button data-shape="circle" class="shape-button px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-500 disabled:bg-gray-600 transition">
                        ì›í˜• (â—)
                    </button>
                    <button data-shape="square" class="shape-button px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-500 disabled:bg-gray-600 transition">
                        ì‚¬ê°í˜• (â– )
                    </button>
                    <button data-shape="diamond" class="shape-button px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-500 disabled:bg-gray-600 transition">
                        ë§ˆë¦„ëª¨ (â—†)
                    </button>
                </div>
            </div>

            <div class="border-t border-gray-700 pt-6">
                <button id="complete-button" class="w-full py-3 bg-red-600 text-white text-xl font-extrabold rounded-lg shadow-xl hover:bg-red-500 transition">
                    âœ”ï¸ ì™„ì„±í–ˆì–´ìš”!
                </button>
            </div>
        </div>
    </div>

    <div id="shape-modal" class="modal fixed inset-0 flex items-center justify-center p-4">
        <div class="modal-content p-8 rounded-xl w-full max-w-md text-center space-y-6 control-bg shadow-2xl">
            <h3 class="text-3xl font-extrabold text-green-400">íŠ¸ë¦¬ ëª¨ì–‘ì„ ì„ íƒí•´ì£¼ì„¸ìš”</h3>
            <p class="text-gray-300">ì„ íƒ í›„ ì¥ì‹í’ˆì„ ì¶”ê°€/í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            
            <div class="flex justify-around gap-4">
                <button data-shape="triangle" class="shape-select-button flex-1 py-4 bg-green-700 text-white font-bold rounded-lg hover:bg-green-600 transition shadow-lg">
                    ì‚¼ê°í˜• íŠ¸ë¦¬ (â–²)
                </button>
                <button data-shape="circle" class="shape-select-button flex-1 py-4 bg-green-700 text-white font-bold rounded-lg hover:bg-green-600 transition shadow-lg">
                    ì›í˜• íŠ¸ë¦¬ (ğŸŸ¢)
                </button>
            </div>
        </div>
    </div>

    <div id="complete-message">
        <div id="complete-image-wrapper" class="w-full max-w-lg sm:max-w-xl md:max-w-2xl h-auto shadow-2xl rounded-lg border-4 border-white overflow-hidden">
            <img id="complete-image" 
             src="image/completed_tree.png"
                 alt="" 
                 class="w-full h-full object-cover">
        </div>
    </div>

    <div class="fixed bottom-2 left-2 text-[10px] text-gray-500 font-sans z-0 pointer-events-none text-left opacity-70">
        <p>Copyright (C) 2025, hanyang univ. class of 2025 College of Advanced Technology and Convergence - bio team 2</p>
        <p class="mt-0.5">
            coded by Google Gemini 3 pro, 
            <a href="https://github.com/CADIS57/open-source-bio-team-2" target="_blank" class="hover:text-gray-300 pointer-events-auto underline">
                https://github.com/CADIS57/open-source-bio-team-2
            </a>
        </p>
    </div>

    <script>
        // --- 1. ìƒíƒœ ë° ì´ˆê¸° ë°ì´í„° ---
        
        const INITIAL_ORNAMENTS = 5;
        const PRESET_COLORS = ['#FF0000', '#FFA500', '#FFFF00', '#008000', '#0000FF', '#4B0082', '#EE82EE', '#FFFFFF'];
        // [13ì°¨ ì»¤ë°‹ì—ì„œ ê°€ì ¸ì˜¨ ìƒìˆ˜] ê²½ê³„ ê³„ì‚°ì„ ìœ„í•´ í•„ìš”
        const TREE_LEAF_HEIGHT_PERCENT = 85;
        const CONTAINER_HEIGHT_PX = 400;

        let ornaments = [];
        let nextOrnamentId = 1;
        let selectedOrnamentId = null;
        let isCompletedMode = false;
        // [13ì°¨ ì»¤ë°‹ì˜ ë“œë˜ê·¸ ê´€ë ¨ ìƒíƒœ ë³€ìˆ˜]
        let isDragging = false;
        let wasDragged = false;
        let draggedOrnament = null;
        let dragOffset = { x: 0, y: 0 };
        // --- 2. DOM ìš”ì†Œ ì°¸ì¡° ---
        
        const leafsArea = document.getElementById('leafs-area');
        const treeContainer = document.getElementById('tree-container');
        const treeSection = document.getElementById('tree-section');
        const mainLayout = document.getElementById('main-layout');
        
        const panelTitle = document.getElementById('panel-title');
        const nativeColorInput = document.getElementById('native-color-input');
        const hexColorInput = document.getElementById('hex-color-input');
        const presetColorsContainer = document.getElementById('preset-colors');
        const statusMessage = document.getElementById('status-message');
        
        const shapeButtons = document.querySelectorAll('.shape-button');
        const shapeModal = document.getElementById('shape-modal');
        const completeButton = document.getElementById('complete-button');
        const completeMessage = document.getElementById('complete-message');
        const resetButton = document.getElementById('reset-button');
        
        const mainHeader = document.getElementById('main-header');
        const controlPanel = document.getElementById('control-panel');
        const sizeSlider = document.getElementById('size-slider');
        const sizeDisplay = document.getElementById('size-display');
        
        const addOrnamentButton = document.getElementById('add-ornament-button');
        const deleteOrnamentButton = document.getElementById('delete-ornament-button');
        // --- 3. ë Œë”ë§ ë° UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---

        function renderOrnament(ornament) {
            let element = document.getElementById(`ornament-${ornament.id}`);
            if (!element) {
                element = document.createElement('div');
                element.id = `ornament-${ornament.id}`;
                element.className = 'ornament';
                
                // [13ì°¨ ì»¤ë°‹ ë°©ì‹] ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
                element.addEventListener('mousedown', startDrag);
                element.addEventListener('touchstart', startDrag, { passive: false });
                
                element.addEventListener('click', (e) => {
                    // [13ì°¨ ì»¤ë°‹ ë°©ì‹] ë“œë˜ê·¸ê°€ ì•„ë‹ˆì—ˆì„ ë•Œë§Œ ì„ íƒ ë¡œì§ ì‹¤í–‰
                    e.stopPropagation();
                    if (!wasDragged) {
                        handleOrnamentClick(ornament.id);
                    }
                });
                leafsArea.appendChild(element);
            }

            // ëª¨ì–‘ í´ë˜ìŠ¤ ì—…ë°ì´íŠ¸
            element.className = 'ornament';
            element.classList.add(`shape-${ornament.shape}`);

            // isSelected ìƒíƒœì— ë”°ë¼ 'selected' í´ë˜ìŠ¤ ì¶”ê°€
            if (ornament.isSelected) {
                element.classList.add('selected');
            }
            
            // ì™„ë£Œ ëª¨ë“œ ì‹œ ìƒí˜¸ì‘ìš© ë°©ì§€
            if (isCompletedMode) {
                // CSSì—ì„œ .completed-mode .ornamentë¡œ ì œì–´í•˜ì§€ë§Œ JSì—ì„œë„ í™•ì‹¤íˆ
            }

            // ìŠ¤íƒ€ì¼ ì ìš©
            element.style.backgroundColor = ornament.color;
            element.style.width = `${ornament.size}px`;
            element.style.height = `${ornament.size}px`;
            
            const halfSize = ornament.size / 2;
            element.style.left = `${ornament.x - halfSize}px`;
            element.style.top = `${ornament.y - halfSize}px`;
            
            return element;
        }

        function renderAllOrnaments() {
            leafsArea.innerHTML = '';
            // ì´ˆê¸°í™”
            ornaments.forEach(ornament => {
                renderOrnament(ornament);
            });
            updateControlPanel();
        }

        function updateControlPanel() {
            if (isCompletedMode) return;
            // ì™„ë£Œ ëª¨ë“œë©´ íŒ¨ë„ ì—…ë°ì´íŠ¸ ì•ˆ í•¨

            const isSelected = selectedOrnamentId !== null;
            const activeOrnament = isSelected ? ornaments.find(o => o.id === selectedOrnamentId) : null;
            // ë²„íŠ¼ ìƒíƒœ í™œì„±í™”/ë¹„í™œì„±í™”
            nativeColorInput.disabled = !isSelected;
            hexColorInput.disabled = !isSelected;
            sizeSlider.disabled = !isSelected;
            deleteOrnamentButton.disabled = !isSelected;

            shapeButtons.forEach(btn => btn.disabled = !isSelected);
            if (isSelected && activeOrnament) {
                // ìƒ‰ìƒ ì…ë ¥ ì—…ë°ì´íŠ¸
                nativeColorInput.value = activeOrnament.color;
                hexColorInput.value = activeOrnament.color;
                
                // í¬ê¸° ìŠ¬ë¼ì´ë” ì—…ë°ì´íŠ¸
                sizeSlider.value = activeOrnament.size;
                sizeDisplay.textContent = activeOrnament.size;

                // ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                panelTitle.textContent = "ì¥ì‹í’ˆ í¸ì§‘ ì¤‘...";
                statusMessage.textContent = "ìƒ‰ìƒ, í¬ê¸°, ëª¨ì–‘ì„ ë³€ê²½í•˜ê±°ë‚˜ ë“œë˜ê·¸í•˜ì—¬ ì´ë™í•˜ì„¸ìš”.";

                // ëª¨ì–‘ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
                const shape = activeOrnament.shape;
                shapeButtons.forEach(btn => {
                    const btnShape = btn.getAttribute('data-shape');
                    if (btnShape === shape) {
                        btn.classList.replace('bg-blue-600', 'bg-red-600');
                        btn.classList.replace('hover:bg-blue-500', 'hover:bg-red-500');
                    } else {
                        btn.classList.replace('bg-red-600', 'bg-blue-600');
                        btn.classList.replace('hover:bg-red-500', 'hover:bg-blue-500');
                    }
                });

            } else {
                nativeColorInput.value = '#ffffff';
                hexColorInput.value = '#FFFFFF';
                sizeSlider.value = 25;
                sizeDisplay.textContent = 25;
                
                statusMessage.textContent = 'í´ë¦­í•˜ì—¬ ì¥ì‹í’ˆì˜ ìƒ‰ìƒ/ëª¨ì–‘/í¬ê¸°ë¥¼ ë³€ê²½í•˜ê³  ë“œë˜ê·¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            }

            // í”„ë¦¬ì…‹ ë²„íŠ¼ ì—…ë°ì´íŠ¸
            presetColorsContainer.querySelectorAll('.preset-button').forEach(button => {
                const buttonColor = button.getAttribute('data-color');
                button.disabled = !isSelected;
                if (isSelected && buttonColor === nativeColorInput.value) {
                    button.style.border = '3px solid #38bdf8';
                } else {
                    button.style.border = '1px solid #333';
                }
            });
        }

        // --- 4. ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬: ì„ íƒ ë° í¸ì§‘ ---

        function handleOrnamentClick(id) {
            if (isCompletedMode) return;
            selectedOrnamentId = id;
            ornaments = ornaments.map(o => ({
                ...o,
                isSelected: o.id === id,
            }));
            renderAllOrnaments();
            updateControlPanel();
        }

        function applyColorChange(newColor) {
            if (selectedOrnamentId === null || !/^#[0-9A-Fa-f]{6}$/i.test(newColor)) return;
            ornaments = ornaments.map(o => o.id === selectedOrnamentId ? { ...o, color: newColor.toUpperCase() } : o );
            renderAllOrnaments();
            updateControlPanel();
        }

        function applyShapeChange(newShape) {
            if (selectedOrnamentId === null) return;
            ornaments = ornaments.map(o => o.id === selectedOrnamentId ? { ...o, shape: newShape } : o );
            renderAllOrnaments();
            updateControlPanel();
        }

        function applySizeChange(newSize) {
            if (selectedOrnamentId === null) return;
            const size = parseInt(newSize);

            ornaments = ornaments.map(o => {
                if (o.id === selectedOrnamentId) {
                    // í¬ê¸° ë³€ê²½ ì‹œ íŠ¸ë¦¬ ê²½ê³„ë¥¼ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡ ì¢Œí‘œ ì¬ì¡°ì •
                    // (ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ ì—¬ê¸°ì„œëŠ” í¬ê¸°ë§Œ ë³€ê²½í•˜ê³  ë Œë”ë§ ì‹œ ìœ„ì¹˜ ì œí•œì€ ë“œë˜ê·¸ì—ì„œ ì²˜ë¦¬)
                    return { ...o, size: size };
                }
                return o;
            });
            renderAllOrnaments();
            updateControlPanel();
        }

        function addOrnament() {
             if (isCompletedMode) return;
             const treeRect = leafsArea.getBoundingClientRect();
             const width = leafsArea.offsetWidth;
             const height = CONTAINER_HEIGHT_PX;
             // ê³ ì • ë†’ì´ ì‚¬ìš©
             
             // íŠ¸ë¦¬ ëª¨ì–‘ í™•ì¸
             const treeShape = treeContainer.classList.contains('tree-shape-triangle') ? 'triangle' : 'circle';
             
             // ëœë¤ ìœ„ì¹˜ ìƒì„± (íŠ¸ë¦¬ ë‚´ë¶€)
             let x, y, isInside = false;
             let attempts = 0;
             const size = 25;
             
             // 13ì°¨ ì»¤ë°‹ì˜ ëœë¤ ìœ„ì¹˜ ë¡œì§ê³¼ ìœ ì‚¬í•˜ê²Œ êµ¬í˜„
             const treeLeafHeightPx = height * (TREE_LEAF_HEIGHT_PERCENT / 100);
             while (!isInside && attempts < 100) {
                 x = Math.random() * (width - size) + size/2;
                 y = Math.random() * (treeLeafHeightPx - size) + size/2;
                 
                 // ê²½ê³„ ì²´í¬
                 const normX = x / width;
                 const normY = y / height;
                 
                 if (treeShape === 'triangle') {
                    const treeHeightNorm = TREE_LEAF_HEIGHT_PERCENT / 100;
                    const slope = 0.5 / treeHeightNorm;
                    const isLeft = normX <= 0.5;
                    const boundaryY = isLeft ? (0.5 - normX) / slope : (normX - 0.5) / slope;
                    if (normY >= boundaryY && normY <= treeHeightNorm) isInside = true;
                 } else {
                    // ì›í˜• (ë‹¨ìˆœí™”ëœ íƒ€ì› ì²´í¬)
                    const h = width / 2;
                    const k = treeLeafHeightPx / 2;
                    const a = width / 2;
                    const b = treeLeafHeightPx / 2;
                    const termX = Math.pow(x - h, 2) / Math.pow(a, 2);
                    const termY = Math.pow(y - k, 2) / Math.pow(b, 2);
                    if (termX + termY <= 1) isInside = true;
                 }
                 attempts++;
             }
             if (!isInside) { x = width/2;
             y = treeLeafHeightPx/2; } // ì‹¤íŒ¨ ì‹œ ì¤‘ì•™

             const newOrnament = {
                 id: nextOrnamentId++,
                 x: x,
                 y: y,
                 color: PRESET_COLORS[Math.floor(Math.random() * PRESET_COLORS.length)],
                 size: 25,
                 shape: 'circle',
                 isSelected: true // ì¶”ê°€í•˜ìë§ˆì ì„ íƒ
             };
             // ê¸°ì¡´ ì„ íƒ í•´ì œ ë° ìƒˆ ì¥ì‹ ì„ íƒ
             ornaments = ornaments.map(o => ({ ...o, isSelected: false }));
             selectedOrnamentId = newOrnament.id;
             
             ornaments.push(newOrnament);
             renderAllOrnaments();
             updateControlPanel();
        }

        function deleteOrnament() {
            if (selectedOrnamentId === null || isCompletedMode) return;
            ornaments = ornaments.filter(o => o.id !== selectedOrnamentId);
            selectedOrnamentId = null;
            
            renderAllOrnaments();
            updateControlPanel();
            statusMessage.textContent = "ì¥ì‹í’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.";
        }

        // --- 5. [ìˆ˜ì •ë¨] ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë¡œì§ (13ì°¨ ì»¤ë°‹ ì½”ë“œ ì ìš©) ---
        
        function getEventCoords(e) {
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            return { clientX, clientY };
        }

        function startDrag(e) {
            if (isCompletedMode) return;
            // ì™„ë£Œ ëª¨ë“œ ì²´í¬ëŠ” 14ì°¨ ê¸°ëŠ¥ ìœ ì§€ë¥¼ ìœ„í•´ ì¶”ê°€
            
            e.preventDefault();
            wasDragged = false; 
            isDragging = true;
            
            const target = e.currentTarget;
            const ornamentId = parseInt(target.id.replace('ornament-', ''));
            draggedOrnament = ornaments.find(o => o.id === ornamentId);

            if (!draggedOrnament) return;
            
            const rect = target.getBoundingClientRect();
            const coords = getEventCoords(e);
            dragOffset.x = coords.clientX - rect.left;
            dragOffset.y = coords.clientY - rect.top;

            target.classList.add('dragging');
            if (!draggedOrnament.isSelected) {
                 // 13ì°¨ ì»¤ë°‹ì˜ selectOrnament ëŒ€ì‹  14ì°¨ì˜ handleOrnamentClick í˜¸ì¶œ
                 handleOrnamentClick(ornamentId);
                 draggedOrnament = ornaments.find(o => o.id === ornamentId); 
            }
        }

        function onDrag(e) {
            if (!isDragging || !draggedOrnament) return;
            e.preventDefault(); 
            
            if (!wasDragged) { wasDragged = true; }

            const coords = getEventCoords(e);
            const containerRect = leafsArea.getBoundingClientRect();
            
            const newLeft = coords.clientX - containerRect.left - dragOffset.x;
            const newTop = coords.clientY - containerRect.top - dragOffset.y;
            const size = draggedOrnament.size;
            const halfSize = size / 2;
            const maxLeafWidth = leafsArea.offsetWidth;
            const maxLeafHeight = leafsArea.offsetHeight;
            let centerX = newLeft + halfSize;
            let centerY = newTop + halfSize;
            // ìº”ë²„ìŠ¤ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ 1ì°¨ ì œí•œ
            centerX = Math.max(halfSize, Math.min(maxLeafWidth - halfSize, centerX));
            centerY = Math.max(halfSize, Math.min(maxLeafHeight - halfSize, centerY));
            
            const currentShape = treeContainer.classList.contains('tree-shape-triangle') ? 'triangle' : 'circle';
            // 13ì°¨ ì»¤ë°‹ì˜ ê²½ê³„ ê³„ì‚° í•¨ìˆ˜ ì‚¬ìš©
            const { x: validX, y: validY } = keepInTreeBounds(currentShape, centerX, centerY, maxLeafWidth, CONTAINER_HEIGHT_PX, halfSize);
            centerX = validX;
            centerY = validY;
            draggedOrnament.x = centerX;
            draggedOrnament.y = centerY;

            const el = document.getElementById(`ornament-${draggedOrnament.id}`);
            if (el) {
                el.style.left = `${centerX - halfSize}px`;
                el.style.top = `${centerY - halfSize}px`;
            }
        }
        
        function keepInTreeBounds(treeShape, x, y, width, containerHeight, halfSize) {
            const treeLeafHeightPx = leafsArea.offsetHeight;
            if (treeShape === 'triangle') {
                const normX = x / width;
                // TREE_LEAF_HEIGHT_PERCENT ìƒìˆ˜ëŠ” 1ë²ˆ ì„¹ì…˜ì— ì •ì˜ë¨
                const treeHeightNorm = TREE_LEAF_HEIGHT_PERCENT / 100 * (treeLeafHeightPx / containerHeight);
                const slope = 0.5 / treeHeightNorm;
                
                // ì‚¼ê°í˜• ë¹—ë³€ ê³„ì‚°
                const boundaryY = (x <= width / 2) ? (0.5 - normX) / slope * treeLeafHeightPx : (normX - 0.5) / slope * treeLeafHeightPx;
                if (y < boundaryY + halfSize) { 
                    y = boundaryY + halfSize;
                }
            } 
            // ì›í˜•ì€ ë³„ë„ ì œí•œ ì—†ì´ ì‚¬ê°í˜• ì˜ì—­ ì‚¬ìš© (13ì°¨ ì»¤ë°‹ ê¸°ì¤€)
            return { x, y };
        }

        function endDrag() {
            if (isDragging) {
                isDragging = false;
                draggedOrnament = null;
                const draggingEl = document.querySelector('.ornament.dragging');
                if (draggingEl) {
                    draggingEl.classList.remove('dragging');
                }
            }
        }

        // --- 6. íŠ¸ë¦¬ ì„¤ì • ë° ì™„ë£Œ ì²˜ë¦¬ ---

        function setTreeShape(shape) {
            treeContainer.classList.remove('tree-shape-triangle', 'tree-shape-circle');
            treeContainer.classList.add(`tree-shape-${shape}`);
            
            // 14ì°¨ ì»¤ë°‹ì˜ ìì‚¬ê·€ í´ë¦¬í•‘ ì´ˆê¸°í™”
            if (shape === 'triangle') {
               // CSS í´ë˜ìŠ¤ë¡œ ì²˜ë¦¬ë¨
            }
        }

        function initializeApp() {
            // í”„ë¦¬ì…‹ ìƒ‰ìƒ ë²„íŠ¼ ìƒì„±
            PRESET_COLORS.forEach(color => {
                const btn = document.createElement('button');
                btn.className = 'preset-button w-8 h-8 rounded-full border border-gray-700 hover:scale-110 transition';
                btn.style.backgroundColor = color;
                btn.setAttribute('data-color', color);
                btn.addEventListener('click', (e) => {
                    if (e.target.disabled) return;
                    applyColorChange(color);
                });
                presetColorsContainer.appendChild(btn);
            });
            // ì´ˆê¸° ì´ë²¤íŠ¸ ì—°ê²°
            nativeColorInput.addEventListener('input', (e) => {
                hexColorInput.value = e.target.value.toUpperCase();
                applyColorChange(e.target.value);
            });
            hexColorInput.addEventListener('change', (e) => applyColorChange(e.target.value));
            
            sizeSlider.addEventListener('input', (e) => {
                sizeDisplay.textContent = e.target.value;
                applySizeChange(e.target.value);
            });
            shapeButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    if (e.target.disabled) return;
                    const shape = e.target.getAttribute('data-shape');
                    applyShapeChange(shape);
                });
            });

            completeButton.addEventListener('click', handleComplete);
            resetButton.addEventListener('click', resetApp);
            addOrnamentButton.addEventListener('click', addOrnament);
            deleteOrnamentButton.addEventListener('click', deleteOrnament);

            // íŠ¸ë¦¬ ëª¨ì–‘ ì„ íƒ ëª¨ë‹¬ ë²„íŠ¼
            document.querySelectorAll('.shape-select-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                     const shape = e.target.getAttribute('data-shape');
                     setTreeShape(shape);
                     shapeModal.style.display = 'none';
                     
                     // ì´ˆê¸° ì¥ì‹í’ˆ ìƒì„±
                     ornaments = [];
                     for(let i=0; i<INITIAL_ORNAMENTS; i++) addOrnament();
                     // ì²˜ìŒì— ë§ˆì§€ë§‰ ì¶”ê°€ëœ ê²ƒì´ ì„ íƒë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì´ˆê¸°í™” í˜¹ì€ ìœ ì§€
                     statusMessage.textContent = 'íŠ¸ë¦¬ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. ì¥ì‹ì„ ê¾¸ë©°ë³´ì„¸ìš”!';
                });
            });
            // [13ì°¨ ì»¤ë°‹ ë°©ì‹] ì „ì—­ ë“œë˜ê·¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchmove', onDrag, { passive: false }); 
            document.addEventListener('touchend', endDrag);
            // [13ì°¨ ì»¤ë°‹ ë°©ì‹] ë°°ê²½ í´ë¦­ ì‹œ ì„ íƒ í•´ì œ (wasDragged í™•ì¸)
            leafsArea.addEventListener('click', (e) => {
                if (e.target.id === 'leafs-area') {
                    if (!wasDragged) {
                        selectedOrnamentId = null;
                        renderAllOrnaments(); // ì„ íƒ í•´ì œ ë°˜ì˜
                        updateControlPanel();
                    }
                }
                wasDragged = false; 
            });

            resetApp();
        }

        // --- 7. ì™„ë£Œ ê¸°ëŠ¥ ---
        function handleComplete() {
            completeButton.disabled = true;
            mainHeader.style.display = 'none';
            controlPanel.style.display = 'none';
            resetButton.style.display = 'none';

            document.body.classList.add('completed-mode');
            isCompletedMode = true;
            selectedOrnamentId = null; 
            renderAllOrnaments(); 

            mainLayout.classList.add('completed-layout');
            treeSection.classList.remove('lg:w-1/2');
            treeSection.classList.add('lg:w-full');
            treeContainer.style.transform = 'scale(1.5)';
            
            setTimeout(() => {
                completeMessage.classList.add('show'); 
                resetButton.style.display = 'block'; 

                // [ìˆ˜ì •ë¨] 3ì´ˆ ë’¤ì— ë©”ì‹œì§€ ì°½ ì‚¬ë¼ì§€ê²Œ ì„¤ì •
                setTimeout(() => {
                    completeMessage.classList.remove('show');
                }, 3000);

            }, 600);
        }

        function resetApp() {
            isCompletedMode = false;
            document.body.classList.remove('completed-mode');
            completeMessage.classList.remove('show');
            
            mainHeader.style.display = 'block';
            controlPanel.style.display = 'block';
            mainLayout.classList.remove('completed-layout');
            treeSection.classList.remove('lg:w-full');
            treeSection.classList.add('lg:w-1/2');
            treeContainer.style.transform = 'scale(1)';

            updateControlPanel();
            shapeModal.style.display = 'flex';
            resetButton.style.display = 'none';
            completeButton.disabled = false;
        }

        window.onload = initializeApp;
    </script>
</body>
</html>